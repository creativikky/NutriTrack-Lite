
<!DOCTYPE html>
<html>
<head>
  <title>Ingredients</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: white; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #eef; }
    .btn { padding: 5px 10px; margin: 5px; border-radius: 4px; cursor: pointer; }
    .btn-add { background-color: #007bff; color: white; }
    .btn-delete { background-color: #dc3545; color: white; }
  </style>
</head>
<body>

<a class="btn" href="dashboard.html">â¬… Go to Dashboard</a>
<h2>Ingredient Lookup Table</h2>

<table>
  <thead>
    <tr>
      <th>Item</th>
      <th>Per Unit Qty</th>
      <th>Unit</th>
      <th>Calories</th>
      <th>Protein</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="ingredientTable"></tbody>
</table>

<button class="btn btn-add" onclick="document.getElementById('ingredientDialog').showModal()">+ Add New Ingredient</button>

<dialog id="ingredientDialog">
  <form method="dialog" onsubmit="saveIngredient(event)">
    <h3>Add Ingredient</h3>
    <input type="text" id="itemInput" placeholder="Item name" required />
    <input type="number" step="0.01" id="qtyInput" placeholder="Per Unit Qty" required />
    <input type="text" id="unitInput" placeholder="Unit (e.g. gm, ml)" required />
    <input type="number" step="0.01" id="caloriesInput" placeholder="Calories" required />
    <input type="number" step="0.01" id="proteinInput" placeholder="Protein" required />
    <div>
      <button class="btn" type="submit">Save</button>
      <button class="btn btn-delete" onclick="document.getElementById('ingredientDialog').close()">Cancel</button>
    </div>
  </form>
</dialog>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyBpmurxYdJpAzOzUVALHqTojYR7ULiIPEM",
  authDomain: "nutritrack-lite-795b2.firebaseapp.com",
  projectId: "nutritrack-lite-795b2",
  storageBucket: "nutritrack-lite-795b2.firebasestorage.app",
  messagingSenderId: "1089632956766",
  appId: "1:1089632956766:web:be972b8f74b079e6609fcf",
  measurementId: "G-P5R1VXPY3E"
};
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUID = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      currentUID = user.uid;
      loadIngredients();
    }
  });

  async function loadIngredients() {
    const q = query(collection(db, "ingredients"), where("uid", "==", currentUID));
    const snapshot = await getDocs(q);
    const tbody = document.getElementById("ingredientTable");
    tbody.innerHTML = "";
    if (snapshot.empty) {
      tbody.innerHTML = `<tr><td colspan='6' style='color:#666;font-style:italic'>No ingredients found.</td></tr>`;
      return;
    }
    snapshot.forEach(docSnap => {
      const ing = docSnap.data();
      const id = docSnap.id;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${ing.item}</td>
        <td>${ing.qty}</td>
        <td>${ing.unit}</td>
        <td>${ing.calories}</td>
        <td>${ing.protein}</td>
        <td><button class='btn btn-delete' onclick='deleteIngredient("${id}")'>Delete</button></td>
`;
      tbody.appendChild(row);
    });
  }

  window.saveIngredient = async function(e) {
    e.preventDefault();
    const item = document.getElementById("itemInput").value.trim();
    const qty = document.getElementById("qtyInput").value.trim();
    const unit = document.getElementById("unitInput").value.trim();
    const calories = document.getElementById("caloriesInput").value.trim();
    const protein = document.getElementById("proteinInput").value.trim();

    if (!item || !qty || !unit || !calories || !protein) return;

    await addDoc(collection(db, "ingredients"), {
      uid: currentUID,
      item, qty, unit, calories, protein
    });
    document.getElementById("ingredientDialog").close();
    loadIngredients();
  }

  window.deleteIngredient = async function(id) {
    await deleteDoc(doc(db, "ingredients", id));
    loadIngredients();
  }

  window.editIngredient = function(id, btn) {
    const row = btn.closest("tr");
    const cells = row.querySelectorAll("td");
    const values = Array.from(cells).slice(0, 5).map(td => td.textContent);

    cells[0].innerHTML = `<input value="\${values[0]}" />`;
    cells[1].innerHTML = `<input value="\${values[1]}" />`;
    cells[2].innerHTML = `<input value="\${values[2]}" />`;
    cells[3].innerHTML = `<input type="number" step="0.01" value="\${values[3]}" />`;
    cells[4].innerHTML = `<input type="number" step="0.01" value="\${values[4]}" />`;
    cells[5].innerHTML = `
      <button class='btn' onclick='saveEdit("\${id}", this)'>Save</button>
      <button class='btn btn-delete' onclick='loadIngredients()'>Cancel</button>
    `;
  }

  window.saveEdit = async function(id, btn) {
    const row = btn.closest("tr");
    const inputs = row.querySelectorAll("input");

    const updated = {
      item: inputs[0].value.trim(),
      qty: inputs[1].value.trim(),
      unit: inputs[2].value.trim(),
      calories: inputs[3].value.trim(),
      protein: inputs[4].value.trim()
    };

    await updateDoc(doc(db, "ingredients", id), updated);
    await loadIngredients();
  }

</script>

</body>
</html>
